name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  front-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: front
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package.json

      - name: Install dependencies
        run: npm install

      - name: Prepare test reports directory
        run: mkdir -p test-results

      - name: Run tests with JUnit report
        run: >
          npm run test -- --run
          --reporter=default
          --reporter=github-actions
          --reporter=junit
          --outputFile.junit=./test-results/front-junit.xml

      - name: Upload front test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: front-test-report
          path: front/test-results/front-junit.xml
          if-no-files-found: warn

      - name: Front test summary
        if: always()
        run: |
          REPORT_FILE="test-results/front-junit.xml"
          if [ ! -f "$REPORT_FILE" ]; then
            echo "### Front Tests" >> "$GITHUB_STEP_SUMMARY"
            echo "No se encontro reporte JUnit." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          get_attr() {
            local attr="$1"
            grep -o "${attr}=\"[0-9]*\"" "$REPORT_FILE" | head -1 | grep -o "[0-9]*" || echo "0"
          }

          TESTS=$(get_attr tests)
          FAILURES=$(get_attr failures)
          ERRORS=$(get_attr errors)
          SKIPPED=$(get_attr skipped)

          {
            echo "### Front Tests"
            echo ""
            echo "| tests | failures | errors | skipped |"
            echo "| ---: | ---: | ---: | ---: |"
            echo "| $TESTS | $FAILURES | $ERRORS | $SKIPPED |"
            echo ""
            echo "Reporte: \`front/test-results/front-junit.xml\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build
        run: npm run build

      - name: Upload front artifact
        uses: actions/upload-artifact@v4
        with:
          name: front-dist
          path: front/dist

  back-ci:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tasksdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d tasksdb"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tasksdb
    defaults:
      run:
        working-directory: back
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: back/package.json

      - name: Install dependencies
        run: npm install

      - name: Prepare test reports directory
        run: mkdir -p test-results

      - name: Run unit tests with JUnit report
        run: >
          npm run test:unit --
          --reporter=default
          --reporter=github-actions
          --reporter=junit
          --outputFile.junit=./test-results/back-unit-junit.xml

      - name: Run integration tests with JUnit report
        run: >
          npm run test:integration --
          --reporter=default
          --reporter=github-actions
          --reporter=junit
          --outputFile.junit=./test-results/back-integration-junit.xml

      - name: Upload back test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: back-test-reports
          path: |
            back/test-results/back-unit-junit.xml
            back/test-results/back-integration-junit.xml
          if-no-files-found: warn

      - name: Back test summary
        if: always()
        run: |
          summarize_report() {
            local label="$1"
            local report_file="$2"

            if [ ! -f "$report_file" ]; then
              echo "| $label | n/a | n/a | n/a | n/a |" >> "$GITHUB_STEP_SUMMARY"
              return
            fi

            get_attr() {
              local attr="$1"
              grep -o "${attr}=\"[0-9]*\"" "$report_file" | head -1 | grep -o "[0-9]*" || echo "0"
            }

            local tests failures errors skipped
            tests=$(get_attr tests)
            failures=$(get_attr failures)
            errors=$(get_attr errors)
            skipped=$(get_attr skipped)

            echo "| $label | $tests | $failures | $errors | $skipped |" >> "$GITHUB_STEP_SUMMARY"
          }

          {
            echo "### Back Tests"
            echo ""
            echo "| suite | tests | failures | errors | skipped |"
            echo "| --- | ---: | ---: | ---: | ---: |"
          } >> "$GITHUB_STEP_SUMMARY"

          summarize_report "unit" "test-results/back-unit-junit.xml"
          summarize_report "integration" "test-results/back-integration-junit.xml"

          {
            echo ""
            echo "Reportes:"
            echo "- \`back/test-results/back-unit-junit.xml\`"
            echo "- \`back/test-results/back-integration-junit.xml\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build
        run: npm run build

      - name: Upload back artifact
        uses: actions/upload-artifact@v4
        with:
          name: back-dist
          path: back/dist

  ci-summary:
    runs-on: ubuntu-latest
    needs: [front-ci, back-ci]
    steps:
      - name: CI succeeded
        run: echo "Front and back jobs passed successfully"
