name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  front-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: front
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package.json

      - name: Install dependencies
        run: npm install

      - name: Prepare test reports directory
        run: mkdir -p test-results coverage

      - name: Run tests with JUnit report
        run: >
          npm run test -- --run
          --reporter=default
          --reporter=github-actions
          --reporter=junit
          --outputFile.junit=./test-results/front-junit.xml
          --coverage
          --coverage.reporter=text-summary
          --coverage.reporter=html
          --coverage.reporter=json-summary
          --coverage.reportsDirectory=./coverage

      - name: Front test summary
        if: always()
        run: |
          REPORT_FILE="test-results/front-junit.xml"
          if [ ! -f "$REPORT_FILE" ]; then
            echo "### Front Tests" >> "$GITHUB_STEP_SUMMARY"
            echo "No se encontro reporte JUnit." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          get_attr() {
            local attr="$1"
            grep -o "${attr}=\"[0-9]*\"" "$REPORT_FILE" | head -1 | grep -o "[0-9]*" || echo "0"
          }

          TESTS=$(get_attr tests)
          FAILURES=$(get_attr failures)
          ERRORS=$(get_attr errors)
          SKIPPED=$(get_attr skipped)

          {
            echo "### Front Tests"
            echo ""
            echo "| tests | failures | errors | skipped |"
            echo "| ---: | ---: | ---: | ---: |"
            echo "| $TESTS | $FAILURES | $ERRORS | $SKIPPED |"
          } >> "$GITHUB_STEP_SUMMARY"

          TEST_CASES=$(node -e 'const fs=require("fs");const xml=fs.readFileSync(process.argv[1],"utf8");const names=[];for(const m of xml.matchAll(/<testcase\b([^>]*)>/g)){const attrs=m[1];const name=(attrs.match(/\bname="([^"]*)"/)||[])[1]||"";const cls=(attrs.match(/\bclassname="([^"]*)"/)||[])[1]||"";if(name)names.push(cls?`${cls} :: ${name}`:name);}process.stdout.write(names.join("\n"));' "$REPORT_FILE" || true)
          if [ -n "$TEST_CASES" ]; then
            {
              echo ""
              echo "Detalle de tests ejecutados:"
            } >> "$GITHUB_STEP_SUMMARY"

            while IFS= read -r test_case; do
              [ -n "$test_case" ] && echo "- $test_case" >> "$GITHUB_STEP_SUMMARY"
            done <<< "$TEST_CASES"
          fi

      - name: Front coverage summary
        if: always()
        run: |
          COVERAGE_FILE="coverage/coverage-summary.json"
          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "### Front Coverage" >> "$GITHUB_STEP_SUMMARY"
            echo "No se encontro coverage-summary.json." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          METRICS=$(node -e "const fs=require('fs');const t=JSON.parse(fs.readFileSync(process.argv[1],'utf8')).total;const fmt=(n)=>Number(n||0).toFixed(2);process.stdout.write([fmt(t.lines.pct),fmt(t.functions.pct),fmt(t.branches.pct),fmt(t.statements.pct)].join(' '));" "$COVERAGE_FILE")
          IFS=' ' read -r LINES FUNCTIONS BRANCHES STATEMENTS <<< "$METRICS"

          {
            echo "### Front Coverage"
            echo ""
            echo "| lines | functions | branches | statements |"
            echo "| ---: | ---: | ---: | ---: |"
            echo "| ${LINES}% | ${FUNCTIONS}% | ${BRANCHES}% | ${STATEMENTS}% |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build
        run: npm run build

      - name: Upload front artifact
        uses: actions/upload-artifact@v4
        with:
          name: front-dist
          path: front/dist

  back-ci:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tasksdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d tasksdb"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tasksdb
    defaults:
      run:
        working-directory: back
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: back/package.json

      - name: Install dependencies
        run: npm install

      - name: Prepare test reports directory
        run: mkdir -p test-results coverage/unit coverage/integration

      - name: Run unit tests with JUnit report
        run: >
          npm run test:unit --
          --reporter=default
          --reporter=github-actions
          --reporter=junit
          --outputFile.junit=./test-results/back-unit-junit.xml
          --coverage
          --coverage.reporter=text-summary
          --coverage.reporter=html
          --coverage.reporter=json-summary
          --coverage.reportsDirectory=./coverage/unit

      - name: Run integration tests with JUnit report
        run: >
          npm run test:integration --
          --reporter=default
          --reporter=github-actions
          --reporter=junit
          --outputFile.junit=./test-results/back-integration-junit.xml
          --coverage
          --coverage.reporter=text-summary
          --coverage.reporter=html
          --coverage.reporter=json-summary
          --coverage.reportsDirectory=./coverage/integration

      - name: Back test summary
        if: always()
        run: |
          summarize_report() {
            local label="$1"
            local report_file="$2"

            if [ ! -f "$report_file" ]; then
              echo "| $label | n/a | n/a | n/a | n/a |" >> "$GITHUB_STEP_SUMMARY"
              return
            fi

            get_attr() {
              local attr="$1"
              grep -o "${attr}=\"[0-9]*\"" "$report_file" | head -1 | grep -o "[0-9]*" || echo "0"
            }

            local tests failures errors skipped
            tests=$(get_attr tests)
            failures=$(get_attr failures)
            errors=$(get_attr errors)
            skipped=$(get_attr skipped)

            echo "| $label | $tests | $failures | $errors | $skipped |" >> "$GITHUB_STEP_SUMMARY"
          }

          append_case_list() {
            local label="$1"
            local report_file="$2"

            if [ ! -f "$report_file" ]; then
              return
            fi

            local test_cases
            test_cases=$(node -e 'const fs=require("fs");const xml=fs.readFileSync(process.argv[1],"utf8");const names=[];for(const m of xml.matchAll(/<testcase\b([^>]*)>/g)){const attrs=m[1];const name=(attrs.match(/\bname="([^"]*)"/)||[])[1]||"";const cls=(attrs.match(/\bclassname="([^"]*)"/)||[])[1]||"";if(name)names.push(cls?`${cls} :: ${name}`:name);}process.stdout.write(names.join("\n"));' "$report_file" || true)
            if [ -z "$test_cases" ]; then
              return
            fi

            {
              echo ""
              echo "Detalle $label:"
            } >> "$GITHUB_STEP_SUMMARY"

            while IFS= read -r test_case; do
              [ -n "$test_case" ] && echo "- $test_case" >> "$GITHUB_STEP_SUMMARY"
            done <<< "$test_cases"
          }

          {
            echo "### Back Tests"
            echo ""
            echo "| suite | tests | failures | errors | skipped |"
            echo "| --- | ---: | ---: | ---: | ---: |"
          } >> "$GITHUB_STEP_SUMMARY"

          summarize_report "unit" "test-results/back-unit-junit.xml"
          summarize_report "integration" "test-results/back-integration-junit.xml"
          append_case_list "unit" "test-results/back-unit-junit.xml"
          append_case_list "integration" "test-results/back-integration-junit.xml"

      - name: Back coverage summary
        if: always()
        run: |
          summarize_coverage() {
            local label="$1"
            local coverage_file="$2"

            if [ ! -f "$coverage_file" ]; then
              echo "| $label | n/a | n/a | n/a | n/a |" >> "$GITHUB_STEP_SUMMARY"
              return
            fi

            metrics=$(node -e "const fs=require('fs');const t=JSON.parse(fs.readFileSync(process.argv[1],'utf8')).total;const fmt=(n)=>Number(n||0).toFixed(2);process.stdout.write([fmt(t.lines.pct),fmt(t.functions.pct),fmt(t.branches.pct),fmt(t.statements.pct)].join(' '));" "$coverage_file")
            IFS=' ' read -r lines functions branches statements <<< "$metrics"

            echo "| $label | ${lines}% | ${functions}% | ${branches}% | ${statements}% |" >> "$GITHUB_STEP_SUMMARY"
          }

          {
            echo "### Back Coverage"
            echo ""
            echo "| suite | lines | functions | branches | statements |"
            echo "| --- | ---: | ---: | ---: | ---: |"
          } >> "$GITHUB_STEP_SUMMARY"

          summarize_coverage "unit" "coverage/unit/coverage-summary.json"
          summarize_coverage "integration" "coverage/integration/coverage-summary.json"

      - name: Build
        run: npm run build

      - name: Upload back artifact
        uses: actions/upload-artifact@v4
        with:
          name: back-dist
          path: back/dist

  ci-summary:
    runs-on: ubuntu-latest
    needs: [front-ci, back-ci]
    steps:
      - name: CI succeeded
        run: echo "Front and back jobs passed successfully"
